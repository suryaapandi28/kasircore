# version: '3.8'

# services:
#   myapp:
#     build:
#       context: .
#       dockerfile: Dockerfile
#     ports:
#       - "8080:8080"
#     depends_on:
#       - redis
#       - db
#     environment:
#       ENV: "dev"
#       PORT: "8080"
#       POSTGRES_HOST: "localhost"          # ganti localhost dengan db
#       POSTGRES_PORT: "5432"
#       POSTGRES_USER: "kasircore"
#       POSTGRES_PASSWORD: "kasircore"
#       POSTGRES_DATABASE: "kasircore"
#       REDIS_HOST: "redis"          # ganti localhost dengan redis
#       REDIS_PORT: "6379"
#       JWT_SECRET_KEY: "erwhdhsajdahjkdhqwiuou"

#   redis:
#     image: redis:latest
#     ports:
#       - "6379:6379"

#   db:
#     image: postgres:latest
#     environment:
#       - POSTGRES_USER=kasircore
#       - POSTGRES_PASSWORD=kasircore
#       - POSTGRES_DB=kasircore
#     ports:
#       - "5432:5432"



version: '3.8'

services:
  myapp:
    build:
      context: .
      dockerfile: Dockerfile
    expose:
      - "8080"   # gunakan expose, bukan ports (biar hanya bisa diakses lewat network internal)
    depends_on:
      - redis
      - db
    environment:
      ENV: "dev"
      PORT: "8080"
      POSTGRES_HOST: "db"               # arahkan ke service "db", bukan localhost
      POSTGRES_PORT: "5432"
      POSTGRES_USER: "kasircore"
      POSTGRES_PASSWORD: "kasircore"
      POSTGRES_DATABASE: "kasircore"
      REDIS_HOST: "redis"
      REDIS_PORT: "6379"
      JWT_SECRET_KEY: "erwhdhsajdahjkdhqwiuou"

  redis:
    image: redis:latest
    ports:
      - "6379:6379"

  db:
    image: postgres:latest
    environment:
      - POSTGRES_USER=kasircore
      - POSTGRES_PASSWORD=kasircore
      - POSTGRES_DB=kasircore
    ports:
      - "5432:5432"

  nginx:
    image: nginx:latest
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - myapp
